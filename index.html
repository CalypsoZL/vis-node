<!DOCTYPE html>
<html>
  <head>
    <title>Vis Node</title>
    <style type="text/css">
        body {
          margin: 0;
        }
        #container {
          position: absolute;
          width: 100%;
          height: 100%;
        }
      </style>
  </head>
  <body>
    <audio id="audio-element"
           src=""
           controls="true"
           style="width: 512px;">
    </audio>
    <input type="file" id="files" name="files[]" multiple />
    <!-- <div><canvas id="fft" width="512" height="200"></canvas></div> -->
    <!-- <svg id="wav" viewBox="0 -1 6000 2" preserveAspectRatio="none">
        <g>
            <path id="waveform" d=""/>
        </g>
    </svg> -->
    <div id="container"></div>
    <script src="./sigma.min.js"></script>
    <script src="./visnode.js"></script>
    <script src="./index.js"></script>
    <script>
        function handleFileSelect(evt) {
            const files = evt.target.files; // FileList object

            // files is a FileList of File objects. List some properties.
            const output = [];
            for (let i = 0, f; f = files[i]; i++) {
                if (f.type !== "audio/mp3") {
                    continue;
                }
                const aud = document.getElementById("audio-element");
                aud.src = window.URL.createObjectURL(f);
                var audio = new Audio(f);
                audio._loadTrack(f).then((buffer) => {
                    new Waveform("#wav", buffer);
                    console.log(buffer.numberOfChannels)
                    console.log(buffer.getChannelData(0))
                })
            }
        }

        document.getElementById('files').addEventListener('change', handleFileSelect, false);

        class Audio {
            constructor(f) {
                console.log(f)
                this.context = this._createAudioContext();
                // this._loadTrack(f);
            }

            _createAudioContext() {
                if (!window.audioContextInstance) {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;

                if (window.AudioContext) {
                    window.audioContextInstance = new AudioContext();
                } else {
                    alert('Web Audio API is not supported in this browser');
                }
            }

                return window.audioContextInstance;
            }

            _loadTrack(f) {
                return f.arrayBuffer().then((buffer) => {
                    return this.context.decodeAudioData(buffer)
                })
            }
        }
        const PEAK_COUNT = 6000;
        class Waveform {
            constructor(svgPathId, buffer) {
                this.svgPathId = svgPathId;
                this.buffer = buffer;
                // console.log(this._getPeaks(PEAK_COUNT))
                // this.draw();
                this.setNodes(nodes);
            }
            setNodes(nodes) {
                let i = 0;
                const peaks = this._getPeaks(PEAK_COUNT);
                const totalPeaks = peaks.length;
                const aud = document.getElementById("audio-element");
                const interval = setInterval(() => {
                    const a = (~~(i/2)+1)
                    const b = (peaks.shift()+1)
                    nodes[0].input(Math.sqrt(a)/Math.pow(nodes[0].charge+a, 2));
                    nodes[1].input(Math.sqrt(b)/Math.pow(nodes[1].charge+b, 2));
                    // console.log(nodes[0].charge, nodes[1].charge);
                    if (++i >= totalPeaks) clearInterval(peaks);
                }, (aud.duration*1000)/totalPeaks);
                aud.play();
            }

            _getPeaks(length) {
                const sampleSize = this.buffer.length / length;
                const sampleStep = ~~(sampleSize / 10) || 1;
                const numberOfChannels = this.buffer.numberOfChannels;
                const mergedPeaks = [];

                for (let channelNumber = 0; channelNumber < numberOfChannels; channelNumber++) {
                    const peaks = [];
                    const channelData = this.buffer.getChannelData(channelNumber);

                    for (let peakNumber = 0; peakNumber < length; peakNumber++) {
                        const start = ~~(peakNumber * sampleSize);
                        const end = ~~(start + sampleSize);
                        let min = channelData[0];
                        let max = channelData[0];

                        for (let sampleIndex = start; sampleIndex < end; sampleIndex += sampleStep) {
                            const value = channelData[sampleIndex];

                            if (value > max) { max = value; }
                            if (value < min) { min = value; }
                        }

                        peaks[2 * peakNumber] = max;
                        peaks[2 * peakNumber + 1] = min;

                        if (channelNumber === 0 || max > mergedPeaks[2 * peakNumber]) {
                            mergedPeaks[2 * peakNumber] = max;
                        }

                        if (channelNumber === 0 || min < mergedPeaks[2 * peakNumber + 1]) {
                            mergedPeaks[2 * peakNumber + 1] = min;
                        }
                    }
                }
                return mergedPeaks;
            }

            draw() {
                console.log(this.svgPath())
                document.getElementById("wav").setAttribute('d', this.svgPath());
            }

            // svgPath() {
            //     const peaks = this._getPeaks(PEAK_COUNT);
            //     const totalPeaks = peaks.length;

            //     let d = '';
            //     for(let peakNumber = 0; peakNumber < totalPeaks; peakNumber++) {
            //         if (peakNumber%2 === 0) {
            //             d += ` M${~~(peakNumber/2)}, ${peaks.shift()}`;
            //         } else {
            //             d += ` L${~~(peakNumber/2)}, ${peaks.shift()}`;
            //         }
            //     }
            //     return d;
            // }
        }
        // var audio = new Audio("file:///Users/Theo/Coding_Projects/node-vis/SoundHelix-Song-1.mp3");
        // new Waveform({svgPathId: "#wav", buffer: audio.buffer});
    </script>
  </body>
</html>
